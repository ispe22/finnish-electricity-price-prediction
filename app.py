import json
from pathlib import Path

import altair as alt
import pandas as pd
import streamlit as st

PROJECT_ROOT = Path(__file__).resolve().parent
DATA_DIR = PROJECT_ROOT / "data"
RESULTS_PATH = DATA_DIR / "forecast_results.json"
PAGE_TITLE = "Finnish Electricity Price Predictor"
PAGE_ICON = "⚡"
TZ = "Europe/Helsinki"

st.set_page_config(page_title=PAGE_TITLE, page_icon=PAGE_ICON, layout="wide")


def load_data():
    """
    Loads the predictions json generated by predict.py pipeline.
    Parses timestamps and convert units from €/MWh to c/kWh.
    """
    try:
        with open(RESULTS_PATH, "r") as f:
            data = json.load(f)

        hist_df = pd.DataFrame(data.get("history", []))
        fut_df = pd.DataFrame(data.get("forecast", []))

        if not hist_df.empty:
            hist_df["timestamp"] = pd.to_datetime(hist_df["timestamp"])
            hist_df.set_index("timestamp", inplace=True)
            hist_df["real_price"] = hist_df["real_price"] / 10
            hist_df["pred_price"] = hist_df["pred_price"] / 10

        if not fut_df.empty:
            fut_df["timestamp"] = pd.to_datetime(fut_df["timestamp"])
            fut_df.set_index("timestamp", inplace=True)
            fut_df["pred_price"] = fut_df["pred_price"] / 10
            fut_df["real_price"] = fut_df["real_price"] / 10

        full_df = pd.concat([hist_df, fut_df])

        # Remove duplicates if any overlap
        full_df = full_df[~full_df.index.duplicated(keep="last")]
        full_df = full_df.sort_index()

        return hist_df, fut_df, full_df

    except Exception as e:
        st.error(f"Error loading data: {e}")
        return pd.DataFrame(), pd.DataFrame(), pd.DataFrame()


def main():
    st.title(f"{PAGE_ICON} {PAGE_TITLE}")
    st.markdown("""
        This app predicts 2 days-ahead electricity prices for Finland using **XGBoost**.
        It utilizes live data from **Entso-E, Fingrid, and FMI**. The prices shown are raw, unadjusted, wholesale prices.
        """)

    hist_df, fut_df, full_df = load_data()

    if hist_df.empty or fut_df.empty or full_df.empty:
        st.warning("Issues with data pipeline...")
        return

    # --- Main price outlook graph ---
    st.subheader("Price Outlook")
    st.caption(
        "Comparison of official day-ahead auction prices vs. XGBoost model prediction. The prediction line extends further than official data."
    )

    # Filter data to start from Today 12:00
    now = pd.Timestamp.now(tz=TZ)
    start_plot = now.normalize() + pd.Timedelta(hours=12)

    plot_df = full_df[full_df.index >= start_plot].reset_index()

    base = alt.Chart(plot_df).encode(
        x=alt.X(
            "timestamp:T", title="Time", axis=alt.Axis(format="%a %H:%M", tickCount=10)
        )
    )

    color_scale = alt.Scale(
        domain=["Official Price", "AI Prediction"],
        range=["#1f77b4", "#d62728"],
    )
    # Official price line
    line_real = base.mark_line(strokeWidth=3).encode(
        y=alt.Y("real_price:Q", title="Price (c/kWh)"),
        color=alt.datum("Official Price"),
        tooltip=["timestamp", alt.Tooltip("real_price", format=".2f")],
    )
    # Prediction line
    line_pred = base.mark_line(strokeDash=[5, 5]).encode(
        y=alt.Y("pred_price:Q"),
        color=alt.datum("AI Prediction"),
        tooltip=["timestamp", alt.Tooltip("pred_price", format=".2f")],
    )

    # Current time rule
    now_df = pd.DataFrame({"timestamp": [now]})
    rule = (
        alt.Chart(now_df).mark_rule(color="gray", strokeWidth=2).encode(x="timestamp")
    )
    text = (
        alt.Chart(now_df)
        .mark_text(align="left", dx=5, dy=-150, color="gray", text="Now")
        .encode(x="timestamp")
    )

    chart = (
        alt.layer(line_real, line_pred, rule, text)
        .encode(
            color=alt.Color(
                scale=color_scale, legend=alt.Legend(title="Legend", orient="bottom")
            )
        )
        .properties(height=450)
        .interactive()
    )
    st.altair_chart(chart, width="stretch")

    st.info("""
    **Graph Guide:**
    *   **Vertical Gray Line:** Current Time.
    *   **Blue Line:** Official Day-Ahead Auction Price. Stops when data ends (next day 23:00).
    *   **Red Dashed Line:** AI Prediction. Extends 24h further than official data. Predicted price can be affected by missing forecast data.
    """)

    st.divider()

    # --- Market snapshot: avg, min, max prices---
    today_df = full_df[full_df.index.date == now.date()]
    avg_today = today_df["real_price"].mean()
    min_ts = today_df["real_price"].idxmin()
    min_val = today_df.loc[min_ts, "real_price"]
    min_time = min_ts.strftime("%H:%M")
    max_ts = today_df["real_price"].idxmax()
    max_val = today_df.loc[max_ts, "real_price"]
    max_time = max_ts.strftime("%H:%M")

    col1, col2, col3 = st.columns(3)
    col1.metric("Avg Price (Today)", f"{avg_today:.2f} c/kWh")
    col2.metric(
        "Min Price (Today)",
        f"{min_val:.2f} c/kWh",
        f"at {min_time}",
        delta_color="normal",
    )
    col3.metric(
        "Max Price (Today)",
        f"{max_val:.2f} c/kWh",
        f"at {max_time}",
        delta_color="inverse",
    )

    st.divider()

    # --- Model accuracy (past 7 days) ---
    st.subheader("Model accuracy (past 7 days)")
    st.caption("Comparison: Real Entso-E prices vs. model predictions")

    acc_df = hist_df[hist_df.index < now].reset_index()
    base_acc = alt.Chart(acc_df).encode(
        x=alt.X("timestamp:T", title="Date", axis=alt.Axis())
    )
    # Official price line
    acc_real = base_acc.mark_line(strokeWidth=2).encode(
        y=alt.Y("real_price:Q", title="Price (c/kWh)"),
        color=alt.datum("Official Price"),
        tooltip=["timestamp", alt.Tooltip("real_price", format=".2f")],
    )
    # Prediction line
    acc_pred = base_acc.mark_line(strokeDash=[5, 5]).encode(
        y=alt.Y("pred_price:Q"),
        color=alt.datum("AI Prediction"),
        tooltip=["timestamp", alt.Tooltip("pred_price", format=".2f")],
    )
    acc_chart = (
        alt.layer(acc_real, acc_pred)
        .encode(
            color=alt.Color(
                scale=color_scale,
                legend=alt.Legend(title="Legend", orient="bottom"),
            )
        )
        .properties(height=350)
    )
    st.altair_chart(acc_chart, width="stretch")

    st.divider()

    # --- Market driver analysis graph ---
    st.subheader("Market driver analysis")

    # Define the options mapping
    driver_map = {
        "Residual Demand (Consumption - Wind - Nuclear)": (
            "residual_demand",
            "#FF0000",
        ),
        "Wind Power Forecast": ("wind_forecast", "#1f77b4"),
        "Consumption Forecast": ("consumption_forecast", "#2ca02c"),
        "Temperature (Helsinki)": ("temp_helsinki", "#ff7f0e"),
    }

    driver_option = st.selectbox(
        "Compare Price Forecast with:", list(driver_map.keys())
    )
    col_name, color_hex = driver_map[driver_option]

    expl_df = fut_df.reset_index()

    base_expl = alt.Chart(expl_df).encode(
        x=alt.X("timestamp:T", title="Time", axis=alt.Axis(format="%a %H:%M"))
    )

    driver_chart = base_expl.mark_area(opacity=0.3, color=color_hex).encode(
        y=alt.Y(
            f"{col_name}:Q",
            axis=alt.Axis(title=driver_option, titleColor=color_hex),
        )
    )

    price_chart = base_expl.mark_line(color="#d62728", strokeDash=[5, 5]).encode(
        y=alt.Y(
            "pred_price:Q",
            axis=alt.Axis(title="Predicted Price (c/kWh)", titleColor="#d62728"),
        )
    )

    final_expl_chart = (
        alt.layer(driver_chart, price_chart)
        .resolve_scale(y="independent")
        .properties(height=400)
    )
    st.altair_chart(final_expl_chart, width="stretch")

    # --- Model details and raw data ---
    st.divider()

    with st.expander("Model Architecture & Features", expanded=True):
        st.markdown("""
        **Model:** XGBoost Regressor
        **Objective:** Predict Day-Ahead Spot Price (€/MWh converted to c/kWh)

        **Input Features:**
        1.  **Weather:** Temperature & Wind Speed (Helsinki, Pori) - *Source: FMI*
        2.  **Grid Data:** Wind Power Forecast, Solar Power Forecast, Nuclear Production, Consumption Forecast - *Source: Fingrid*
        3.  **Temporal:** Hour of Day, Day of Week, Month, Is Weekend
        4.  **Autoregressive:** Price Lags (24h, 168h) - *Source: Entso-E*
        """)

    with st.expander("View Raw Data", expanded=True):
        st.caption("Data used for the charts above (Last 7 days + Forecast)")
        st.dataframe(full_df.sort_index(ascending=False).style.format("{:.2f}"))


if __name__ == "__main__":
    main()
